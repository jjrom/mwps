/*
 * mwps - Mapshup Standalone WPS library
 * 
 * mwps is a standalone library extracted from the mapshup applicative framework
 * http://mapshup.info
 *
 * Copyright Jérôme Gasperi, 2013
 *
 * This software is a computer program whose purpose is a webmapping application
 * to display and manipulate geographical data.
 *
 * This software is governed by the CeCILL-B license under French law and
 * abiding by the rules of distribution of free software.  You can  use,
 * modify and/ or redistribute the software under the terms of the CeCILL-B
 * license as circulated by CEA, CNRS and INRIA at the following URL
 * "http://www.cecill.info".
 *
 * As a counterpart to the access to the source code and  rights to copy,
 * modify and redistribute granted by the license, users are provided only
 * with a limited warranty  and the software's author,  the holder of the
 * economic rights,  and the successive licensors  have only  limited
 * liability.
 *
 * In this respect, the user's attention is drawn to the risks associated
 * with loading,  using,  modifying and/or developing or reproducing the
 * software by the user in light of its specific status of free software,
 * that may mean  that it is complicated to manipulate,  and  that  also
 * therefore means  that it is reserved for developers  and  experienced
 * professionals having in-depth computer knowledge. Users are therefore
 * encouraged to load and test the software's suitability as regards their
 * requirements in conditions enabling the security of their systems and/or
 * data to be ensured and,  more generally, to use and operate it in the
 * same conditions as regards security.
 *
 * The fact that you are presently reading this means that you have had
 * knowledge of the CeCILL-B license and that you accept its terms.
 */(function(a,m){a=a||{};a.Util=function(){this.clone=function(a){if("object"!=typeof a||null==a)return a;var c,b=a.constructor();for(c in a)b[c]=this.clone(a[c]);return b};this.extendUrl=function(a,c){var b,d,g,h,i,f={},j="",l=a.split("?")[0];try{i=a.split("?")[1].split("&")}catch(k){i=[]}g=0;for(h=i.length;g<h;g++)b=i[g].split("=")[0],d=i[g].split("=")[1],b&&d&&(f[b]=d);c=$.extend(c,f);for(b in c)j+=b+"="+c[b]+"&";return l+"?"+j};this.stringToRealType=function(a){return!a?a:$.isNumeric(a)?parseFloat(a):
"true"===a.toLowerCase()?!0:"false"===a.toLowerCase()?!1:a};this.getAttributes=function(a){var c,b,d={};if(a&&a.length){a=a[0].attributes;c=0;for(b=a.length;c<b;c++)d[this.stripNS(a[c].nodeName)]=this.stringToRealType(a[c].nodeValue)}return d};this.stripNS=function(a){if(!a)return null;a=a.split(":");return 2===a.length?a[1]:a[0]};this.stripTags=function(a){var c=m.createElement("DIV");c.innerHTML=a;return c.textContent||c.innerText};this.message=function(a){return a};this.isUrl=function(a){return a&&
"string"===typeof a&&(a=a.substr(0,7),"http://"===a||"https:/"===a||"ftp://"===a)?!0:!1};this.proxify=function(a,c,b){if(b&&""!==b){var d=Math.round(865*Math.random()),g=Math.round(757*Math.random());return b+("&a="+d+"&b="+g+"&c="+(d+17-3*(g-2)))+(c?"&returntype="+c:"")+"&url="+encodeURIComponent(a)}return a};this.parseTemplate=function(a,c,b){c=c||{};b=b||{};return"string"===typeof a?a.replace(/\$+([^\$])+\$/g,function(a){var g,a=a.replace(/[\$\$]/g,""),e=c[a];for(g in b)if(a===g){if($.isFunction(b[g].transform))return b[g].transform(e);
break}return null!==e?e:"$"+a+"$"}):a};this.repareUrl=function(a){if(!a)return null;var c=a.indexOf("?");return-1===c?a+"?":c===a.length-1||-1!==a.indexOf("&",a.length-1)?a:a+"&"};this.lowerFirstLetter=function(a){return a.charAt(0).toLowerCase()+a.slice(1)}};a.WPS=function(e){this.events=new a.WPS.Events;this.proxyUrl=this.url=e;this.title=null;this["abstract"]=null;this.version="1.0.0";this.serviceProvider={};this.descriptors=[];this.init=function(a){this.url=a};this.getCapabilities=function(){var c,
b=this;this.title?this.events.trigger("getcapabilities",this):(c=a.Util.extendUrl(this.url,{service:"WPS",version:b.version,request:"GetCapabilities"}),$.ajax({url:a.Util.proxify(a.Util.repareUrl(c),"XML",this.proxyUrl),async:!0,dataType:"xml",success:function(a){b.parseCapabilities(a);b.events.trigger("getcapabilities",b)},error:function(){a.Util.message(a.Util._("Error reading Capabilities file"))}}))};this.describeProcess=function(c){var b,d=this;$.isArray(c)||(c=[c]);if(1===c.length&&(b=this.getProcessDescriptor(c[0]))&&
b.dataInputsDescription)return d.events.trigger("describeprocess",[b]),!0;c=a.Util.extendUrl(d.url,{service:"WPS",version:d.version,request:"DescribeProcess",identifier:c.join(",")});$.ajax({url:a.Util.proxify(a.Util.repareUrl(c),"XML",this.proxyUrl),async:!0,dataType:"xml",success:function(b){var c,e,f=d.parseDescribeProcess(b),j=[],b=0;for(c=f.length;b<c;b++)e=new a.WPS.ProcessDescriptor(f[b]),d.addProcessDescriptor(e),j.push(e);d.events.trigger("describeprocess",j)},error:function(){a.Util.message(a.Util._("Error reading DescribeProcess file"))}});
return!0};this.parseCapabilities=function(c){var b=this;$(c).find("*").filter(function(){if("ServiceIdentification"===a.Util.stripNS(this.nodeName))$(this).children().filter(function(){var c=a.Util.stripNS(this.nodeName);if("Title"===c||"Abstract"===c)b[a.Util.lowerFirstLetter(c)]=$(this).text()});else if("ServiceProvider"===a.Util.stripNS(this.nodeName)){var c={},g={},e={};b.serviceProvider={};$(this).children().filter(function(){switch(a.Util.stripNS(this.nodeName)){case "ServiceContact":$(this).children().each(function(){switch(a.Util.stripNS(this.nodeName)){case "ContactInfo":$(this).children().each(function(){switch(a.Util.stripNS(this.nodeName)){case "Phone":e=
b.parseLeaf($(this));break;case "Address":g=b.parseLeaf($(this))}});break;default:c[a.Util.lowerFirstLetter(a.Util.stripNS(this.nodeName))]=$(this).text()}});break;default:b.serviceProvider[a.Util.lowerFirstLetter(a.Util.stripNS(this.nodeName))]=$(this).text()}});b.serviceProvider.contact=c||{};b.serviceProvider.contact.phone=e;b.serviceProvider.contact.address=g}else"Process"===a.Util.stripNS(this.nodeName)&&b.addProcessDescriptor(new a.WPS.ProcessDescriptor(b.parseLeaf($(this))))});return!0};this.parseDescribeProcess=
function(c){var b=this,d=[];$(c).find("*").filter(function(){if("ProcessDescription"===a.Util.stripNS(this.nodeName)){var c,e={};$.extend(e,a.Util.getAttributes($(this)));$(this).children().filter(function(){c=a.Util.lowerFirstLetter(a.Util.stripNS(this.nodeName));if("dataInputs"===c||"processOutputs"===c)e[c+"Description"]=b.parseDescribePuts($(this).children());else if("title"===c||"identifier"===c||"abstract"===c)e[c]=$(this).text()});d.push(e)}});return d};this.parseDescribePuts=function(c){var b,
d=this,e=[];c.each(function(){var c={};$.extend(c,a.Util.getAttributes($(this)));$(this).children().filter(function(){b=a.Util.lowerFirstLetter(a.Util.stripNS(this.nodeName));if("complexData"===b||"complexOutput"===b)c[b]=d.parseDescribeComplexPut($(this));else if("literalData"===b||"literalOutput"===b)c[b]=d.parseDescribeLiteralPut($(this));else if("boundingBoxData"===b||"boundingBoxOutput"===b)c[b]=d.parseDescribeBoundingBoxPut($(this));else if("title"===b||"identifier"===b||"abstract"===b)c[b]=
$(this).text()});e.push(c)});return e};this.parseDescribeComplexPut=function(c){var b,d=this,e={};$.extend(e,a.Util.getAttributes(c));c.children().filter(function(){b=a.Util.lowerFirstLetter(a.Util.stripNS(this.nodeName));"default"===b?e[b]=d.parseLeaf($(this).children()):"supported"===b&&(e[b]=[],$(this).children().filter(function(){e[b].push(d.parseLeaf($(this)))}))});return e};this.parseDescribeLiteralPut=function(c){var b,d={};$.extend(d,a.Util.getAttributes(c));c.children().filter(function(){b=
a.Util.lowerFirstLetter(a.Util.stripNS(this.nodeName));"dataType"===b&&$.extend(d,a.Util.getAttributes($(this)));"uOMs"===b?(d.UOMs={},$(this).children().filter(function(){b=a.Util.lowerFirstLetter(a.Util.stripNS(this.nodeName));"default"===b?d.UOMs["default"]=$(this).children().text():"supported"===b&&(d.UOMs.supported=[],$(this).children().filter(function(){d.UOMs.supported.push($(this).text())}))})):"allowedValues"===b?(d.allowedValues=[],$(this).children().filter(function(){b=a.Util.lowerFirstLetter(a.Util.stripNS(this.nodeName));
"value"===b&&d.allowedValues.push({value:$(this).text()})})):d[b]=$(this).text()});return d};this.parseDescribeBoundingBoxPut=function(c){var b,d={};c.children().filter(function(){b=a.Util.lowerFirstLetter(a.Util.stripNS(this.nodeName));"default"===b?d[b]=$(this).children().text():"supported"===b&&(d[b]=[],$(this).children().filter(function(){d[b].push($(this).text())}))});return d};this.parseLeaf=function(c,b){var d={};c.children().each(function(){d[b?a.Util.stripNS(this.nodeName):a.Util.lowerFirstLetter(a.Util.stripNS(this.nodeName))]=
$(this).text()});return d};this.execute=function(a,b){var d=this.getProcessDescriptor(a);return!d?!1:d.execute(b)};this.addProcessDescriptor=function(a){if(!a)return!1;$.extend(a,{wps:this});this.descriptors[a.identifier]=a;return!0};this.getProcessDescriptor=function(a){return!a?null:this.descriptors[a]};this.toHTML=function(){return!this.title?"":a.Util.parseTemplate(a.WPS.infoTemplate,{title:this.title,"abstract":this["abstract"],version:this.version,providerSite:this.serviceProvider.providerSite,
providerName:this.serviceProvider.providerName})};this.init(e);return this};a.WPS.ProcessDescriptor=function(e){this.title=this.identifier=this.wps=null;this.outputsProcessDescription=this.dataInputsDescription=this["abstract"]=null;this.inputs=[];this.outputs=[];this.init=function(a){$.extend(this,a)};this.clear=function(){this.clearInputs();this.clearOutputs()};this.clearInputs=function(){this.inputs=[]};this.clearOutputs=function(){this.outputs=[]};this.addInput=function(a){this.inputs.push(a)};
this.addOutput=function(a){this.outputs.push(a)};this.getInputDescription=function(a){if(this.dataInputsDescription&&this.dataInputsDescription.length)for(var b=0,d=this.dataInputsDescription.length;b<d;b++)if(this.dataInputsDescription[b].identifier===a)return this.dataInputsDescription[b];return null};this.execute=function(c){return(new a.WPS.Process({descriptor:this,inputs:a.Util.clone(this.inputs),outputs:a.Util.clone(this.outputs)})).execute(c)};this.init(e);return this};a.WPS.Process=function(e){this.descriptor=
null;this.inputs=[];this.outputs=[];this.result=this.status=this.statusLocation=this.statusAbstract=null;this.init=function(a){$.extend(this,a)};this.execute=function(c){var b,d,e,h,i,f,j="",l="",k=this,c=c||{};this.descriptor.storeSupported||(c.storeExecute=!1);if(!c.hasOwnProperty("storeExecute")){c.storeExecute=!1;b=0;for(d=this.outputs.length;b<d;b++)if("ComplexOutput"===this.outputs[b].type&&!a.Map.Util.getGeoType(this.outputs[b].mimeType)){c.storeExecute=!0;break}}e=a.Util.parseTemplate(a.WPS.executeRequestTemplate,
{identifier:this.descriptor.identifier,storeExecute:c.storeExecute,status:c.storeExecute&&this.descriptor.statusSupported?!0:!1});b=0;for(d=this.inputs.length;b<d;b++)f=this.inputs[b],i=h="","LiteralData"===f.type&&f.data?h=a.Util.parseTemplate(a.WPS.literalDataInputTemplate,{identifier:f.identifier,data:f.data,uom:f.uom||""}):"ComplexData"===f.type&&(f.fileUrl?h=a.Util.parseTemplate(a.WPS.complexDataInputReferenceTemplate,{identifier:f.identifier,reference:f.fileUrl.replace("&","&#038;")}):f.data&&
(h=a.Util.parseTemplate(a.WPS.complexDataInputTemplate,{identifier:f.identifier,data:f.data})),f.format&&(f.format.mimeType&&(i+=' mimeType="'+f.format.mimeType+'"'),f.format.schema&&(i+=' schema="'+f.format.schema+'"'),f.format.encoding&&(i+=' encoding="'+f.format.encoding+'"')),h=h.replace("$format$",i)),l+=h;b=0;for(d=this.outputs.length;b<d;b++)f=this.outputs[b],i=h="","LiteralOutput"===f.type?h=a.Util.parseTemplate(a.WPS.literalOutputTemplate,{identifier:f.identifier}):"ComplexOutput"===f.type?
(c.hasOwnProperty("asReference")||(c.asReference=!0),f.mimeType&&(i+=' mimeType="'+f.mimeType+'"'),h=a.Util.parseTemplate(a.WPS.complexOutputTemplate,{identifier:f.identifier,asReference:a.Map.Util.getGeoType(f.mimeType)?!1:c.asReference,format:i})):"BoundingBoxOutput"===f.type&&(h=a.Util.parseTemplate(a.WPS.boundingBoxOutputTemplate,{identifier:f.identifier})),j+=h;e=a.Util.parseTemplate(e,{dataInputs:l,dataOutputs:j});$.ajax({url:a.Util.proxify(a.Util.repareUrl(k.descriptor.wps.url),"XML",k.descriptor.wps.proxyUrl),
async:!0,type:"POST",dataType:"xml",contentType:"text/xml",data:e,success:function(a){k.result=k.parseExecuteResponse(a);k.result&&k.descriptor.wps.events.trigger("execute",k)},error:function(b){a.Util.message(b)}});return!0};this.parseExecuteResponse=function(c){var b,d=[],e=$(c),h=this;if("ExceptionReport"===a.Util.stripNS(e.children()[0].nodeName))return this.parseException(c),null;if(c=a.Util.getAttributes(e.children()).statusLocation)this.statusLocation=c;e.children().children().filter(function(){"Status"===
a.Util.stripNS(this.nodeName)?(h.status=a.Util.stripNS($(this).children()[0].nodeName),h.statusAbstract=$(this).children().first().text()):"ProcessOutputs"===a.Util.stripNS(this.nodeName)&&$(this).children().each(function(){var c={};$(this).children().each(function(){b=a.Util.lowerFirstLetter(a.Util.stripNS(this.nodeName));"identifier"===b?c[b]=$(this).text():"data"===b?(c.data={},$(this).children().filter(function(){b=a.Util.stripNS(this.nodeName);"LiteralData"===b?c.data.value=$(this).text():"ComplexData"===
b&&($.extend(c.data,a.Util.getAttributes($(this))),c.data.value="WMS"===a.Map.Util.getGeoType(c.data.mimeType)?JSON.parse($.trim($(this).text())):"JSON"===a.Map.Util.getGeoType(c.data.mimeType)?JSON.parse($.trim($(this).text())):$(this).children())})):"reference"===b&&(c.reference=a.Util.getAttributes($(this)))});d.push(c)})});return d};this.parseException=function(){a.Util.message("TODO - parse Exception")};this.init(e);return this};a.WPS.asynchronousProcessManager=function(){this.items=[];this.init=
function(){return this};this.get=function(a){if(!a)return null;for(var c=0,b=this.items.length;c<b;c++)if(this.items[c].statusLocation===a)return this.items[c];return null};this.add=function(e){if(!e)return!1;this.get(e.statusLocation)||(a.Util.message(e.descriptor.title+" : "+a.Util._("Process accepted and running")),this.items.push({id:a.Util.getId(),statusLocation:e.statusLocation,time:(new Date).toISOString(),process:e}),this.update(e))};this.update=function(e){if(!e)return!1;this.get(e.statusLocation)&&
"ProcessSucceeded"!==e.status&&setTimeout(function(){$.ajax({url:a.Util.proxify(e.statusLocation,"XML",e.descriptor.wps.proxyUrl),async:!0,type:"GET",dataType:"xml",contentType:"text/xml",success:function(a){e.result=e.parseExecuteResponse(a);e.result&&e.descriptor.wps.events.trigger("execute",e)},error:function(c){a.Util.message(c)}})},3E3);this.updateProcessesList()};this.remove=function(a){if(!a)return!1;for(var c=0,b=this.items.length;c<b;c++)if(this.items[c].statusLocation===a)return this.items.splice(c,
1),this.updateProcessesList(),!0;return!1};this.updateProcessesList=function(){return!0};return this.init()};a.WPS.Events=function(){this.events={getcapabilities:[],describeprocess:[],execute:[]};this.register=function(a,c,b){this.events[a]&&this.events[a].push({scope:c,handler:b})};this.unRegister=function(a){var c,b,d,g;for(d in this.events){c=this.events[d];b=0;for(g=c.length;b<g;b++)if(c[b].scope===a){c.splice(b,1);break}}};this.trigger=function(a,c){var b,d=this.events[a];if(d)for(b=d.length;b--;)d[b].handler(d[b].scope,
c)};return this};a.WPS.infoTemplate='<div><h1>$title$</h1><p>$abstract$</p><p>Version $version$</p><h2>Provided by <a href="$providerSite$" target="_blank">$providerName$</a></h2></div>';a.WPS.executeRequestTemplate='<?xml version="1.0" encoding="UTF-8" standalone="yes"?><wps:Execute service="WPS" version="1.0.0" xmlns:wps="http://www.opengis.net/wps/1.0.0" xmlns:ows="http://www.opengis.net/ows/1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/wps/1.0.0/wpsExecute_request.xsd"><ows:Identifier>$identifier$</ows:Identifier><wps:DataInputs>$dataInputs$</wps:DataInputs><wps:ResponseForm><wps:ResponseDocument wps:lineage="false" storeExecuteResponse="$storeExecute$" status="$status$">$dataOutputs$</wps:ResponseDocument></wps:ResponseForm></wps:Execute>';
a.WPS.literalDataInputTemplate='<wps:Input><ows:Identifier>$identifier$</ows:Identifier><wps:Data><wps:LiteralData uom="$uom$">$data$</wps:LiteralData></wps:Data></wps:Input>';a.WPS.complexDataInputReferenceTemplate='<wps:Input><ows:Identifier>$identifier$</ows:Identifier><wps:Reference xlink:href="$reference$" $format$/></wps:Input>';a.WPS.complexDataInputTemplate="<wps:Input><ows:Identifier>$identifier$</ows:Identifier><wps:Data><wps:ComplexData $format$>$data$</wps:ComplexData></wps:Data></wps:Input>";
a.WPS.boundingBoxDataInputTemplate='<wps:Input><ows:Identifier>$identifier$</ows:Identifier><wps:Data><wps:BoundingBoxData ows:dimensions="$dimension$" ows:crs="$crs$"><ows:LowerCorner>$minx$ $miny$</ows:LowerCorner><ows:UpperCorner>$maxx$ $maxy$</ows:UpperCorner></wps:BoundingBoxData></wps:Data></wps:Input>';a.WPS.complexOutputTemplate='<wps:Output asReference="$asReference$" $format$><ows:Identifier>$identifier$</ows:Identifier></wps:Output>';a.WPS.literalOutputTemplate='<wps:Output asReference="false"><ows:Identifier>$identifier$</ows:Identifier></wps:Output>';
a.WPS.boundingBoxOutputTemplate=a.WPS.literalOutputTemplate})(window.M,window.document);
